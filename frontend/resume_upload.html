<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ASCEND ‚Äî Resume Upload</title>

  <style>
    :root {
      --accent: #6366f1;
      --accent-2: #4f46e5;
      --bg: #f3f6fb;
      --sidebar-bg: #0f1724;
      --menu-text: #cbd5e1;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: Inter, Segoe UI, Roboto, Arial;
      background: var(--bg);
    }

    .app {
      display: flex;
      min-height: 100vh
    }

    /* ===== SIDEBAR ===== */
    .sidebar {
      width: 300px;
      background: var(--sidebar-bg);
      color: white;
      padding: 26px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .brand-logo {
      width: 140px;
      height: 140px;
      border-radius: 50%;
      background: #0b1220;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
    }

    .brand-logo img {
      width: 80px
    }

    .sidebar-title {
      color: #a5b4fc;
      font-weight: 700;
      margin-bottom: 20px;
    }

    .user-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 24px;
    }

    .user-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #1f2937;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .menu {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .menu button {
      padding: 12px;
      border: none;
      background: transparent;
      color: var(--menu-text);
      font-weight: 600;
      text-align: left;
      cursor: pointer;
      border-radius: 8px;
    }

    .menu button.active {
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      color: white;
    }

    .sidebar-foot {
      margin-top: auto;
      font-size: 12px;
      color: #9aa7c7;
    }

    /* ===== MAIN ===== */
    .main {
      flex: 1;
      padding: 30px
    }

    /* ===== CARDS ===== */
    .card {
      background: white;
      border-radius: 14px;
      padding: 22px;
      margin-bottom: 24px;
    }

    /* ===== UPLOAD ===== */
    .upload-area {
      border: 2px dashed rgba(99, 102, 241, .3);
      border-radius: 12px;
      padding: 30px;
      min-height: 140px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn {
      padding: 10px 22px;
      border-radius: 10px;
      border: none;
      font-weight: 700;
      cursor: pointer;
    }

    .primary-btn {
      background: #5b5cf6;
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .primary-btn:disabled {
      background: #cfcfff;
      cursor: not-allowed;
    }

    /* FORCE Upload & Parse button to be blue */
    #uploadBtn {
      background: linear-gradient(90deg, var(--accent), var(--accent-2)) !important;
      color: #ffffff !important;
      opacity: 1 !important;
    }

    /* ===== ATS ===== */
    .centered {
      display: flex;
      justify-content: center
    }

    svg text {
      font-weight: 800
    }

    .ats-breakdown {
      margin-top: 20px;
      font-weight: 600;
    }

    .ats-breakdown li {
      list-style: none;
      margin-bottom: 8px;
    }

    /* ===== DASHBOARD STATS ===== */
    .stats-grid {
      display: flex;
      gap: 20px;
      margin-top: 20px;
    }

    .stat-card {
      width: 260px;
      height: 130px;
      background: linear-gradient(135deg, #1e3a8a, #2563eb);
      border-radius: 14px;
      padding: 18px;
      color: white;
      box-shadow: 0 12px 28px rgba(37, 99, 235, .35);
    }

    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      opacity: .9;
    }

    .stat-title {
      font-weight: 600;
    }

    .stat-icon {
      background: white;
      color: #1e40af;
      border-radius: 50%;
      width: 26px;
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .stat-value {
      margin-top: 16px;
      font-size: 38px;
      font-weight: 800;
    }

    #resultPanel {
      display: none;
      width: 100%;
      min-height: 70vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .result-card {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, .12);
      text-align: center;
      max-width: 420px;
      width: 100%;
    }

    .circle {
      width: 180px;
      height: 180px;
      border-radius: 50%;
      background: conic-gradient(#e5e7eb 0deg, #e5e7eb 360deg);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      transition: background 1s ease;
    }

    .inside-circle {
      width: 135px;
      height: 135px;
      border-radius: 50%;
      background: white;
      font-size: 28px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
    }

    .comm-card {
      background: white;
      border-radius: 16px;
      padding: 30px;
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.08);
      transition: 0.25s;

    }

    .comm-card {
      transition:
        transform 0.25s ease,
        box-shadow 0.25s ease,
        background 0.25s ease,
        color 0.25s ease;
    }


    .comm-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 16px 30px rgba(0, 0, 0, 0.12);
    }

    .comm-icon {
      font-size: 36px;
      margin-bottom: 12px;
    }

    /* Active (clicked) communication card */
    /* FORCE ACTIVE STATE EVEN ON HOVER */
    .comm-card.active,
    .comm-card.active:hover {
      background: linear-gradient(90deg, #1d169b, #1d169b) !important;
      color: white !important;
      transform: translateY(-6px);
      box-shadow: 0 18px 36px rgba(67, 56, 202, 0.45);
    }

    .comm-card.active h3,
    .comm-card.active p,
    .comm-card.active:hover h3,
    .comm-card.active:hover p {
      color: white !important;
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="brand-logo"><img src="assets/logo.png"></div>
      <div class="sidebar-title">Career Companion</div>

      <div class="user-row">
        <div class="user-icon">üë§</div>
        <strong class="user-greeting">Hi, <span class="user-name-display">Student</span></strong>
      </div>

      <nav class="menu">
        <button id="menuResume" class="active">Resume Upload</button>
        <button id="menuTech" onclick="location.href='technical_test_setup.html'">Technical Test</button>
        <button id="menuComm" onclick="location.href='communication_test.html'">Communication Test</button>
        <button onclick="location.href='mock_interview_setup.html'">Mock Interview</button>
        <button onclick="location.href='opportunities.html'">Opportunities</button>
        <button onclick="location.href='roadmap_setup.html'">Roadmap</button>
        <button id="menuDashboard" onclick="location.href='dashboard.html'">Dashboard</button>
      </nav>


      <div style="margin-top: auto;">
        <button onclick="location.href='index.html'"
          style="background: none; color: #EF4444; width:100%; text-align:left; padding:12px; border:none; font-weight:600; font-size:14px; cursor:pointer; font-family:inherit;">Logout</button>
        <div class="sidebar-foot" style="padding-left:12px; margin-top:0;">Signed in</div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div id="rightContent"></div>

      <!-- DASHBOARD -->
      <div class="card" id="dashboardView" style="display:none">
        <h2>Dashboard</h2>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-header">
              <span class="stat-title">ATS Score</span>
              <span class="stat-icon">üìÑ</span>
            </div>
            <div class="stat-value">
              <span id="dashboardATS">--%</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 1. Selection & Upload -->
      <div id="resumeView">
        <div class="card">
          <h2>Resume Analyzer</h2>
          <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 20px;">
            Select your target role and upload your resume for a rule-based evaluation.
          </p>

          <div style="margin-bottom: 20px;">
            <label for="targetRole" style="font-weight: 600; display: block; margin-bottom: 8px;">Target Job
              Role</label>
            <select id="targetRole"
              style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; font-family: inherit;">
              <option value="">-- Select Target Role --</option>
              <option value="Frontend Developer">Frontend Developer</option>
              <option value="Backend Developer">Backend Developer</option>
              <option value="Full Stack Developer">Full Stack Developer</option>
              <option value="Data Analyst">Data Analyst</option>
            </select>
          </div>

          <div class="upload-area">
            <div>
              <input type="file" id="resumeFile" accept=".pdf,.docx"><br><br>
              <button class="btn primary-btn" id="uploadBtn">Upload & Parse</button>
            </div>
          </div>

          <p id="parsingStatus"
            style="margin-top: 15px; font-size: 0.85rem; color: var(--accent-2); display: none; text-align: center;">
            <span class="spinner"></span> Parsing resume logic...
          </p>
        </div>

        <!-- 2. ATS Results (Step 8, 9) -->
        <div class="card" id="atsResultCard" style="display: none;">
          <h3>ATS Evaluation: <span id="atsScoreTitle">0 / 100</span></h3>

          <div class="centered" style="margin: 30px 0;">
            <svg width="180" height="180" viewBox="0 0 180 180">
              <circle cx="90" cy="90" r="70" stroke="#e6eefc" stroke-width="14" fill="none" />
              <circle id="atsProgress" cx="90" cy="90" r="70" stroke="#16a34a" stroke-width="14" fill="none"
                stroke-linecap="round" stroke-dasharray="439.6" stroke-dashoffset="439.6"
                transform="rotate(-90 90 90)" />
              <text id="atsText" x="50%" y="50%" text-anchor="middle" dominant-baseline="middle" font-size="26"
                font-weight="700">0%</text>
            </svg>
          </div>

          <div id="atsAnalysisContainer" style="text-align: left; margin-top: 20px;">
            <!-- Two-Column Header -->
            <div
              style="display: grid; grid-template-columns: 1fr 1.2fr; gap: 15px; margin-bottom: 10px; padding: 0 10px;">
              <div style="font-weight: 700; color: #4b5563; font-size: 0.85rem; text-transform: uppercase;">‚ùå Issue /
                Error Detected</div>
              <div style="font-weight: 700; color: #4b5563; font-size: 0.85rem; text-transform: uppercase;">‚úÖ How to Fix
                /
                Correct Example</div>
            </div>

            <div id="analysisTableBody" style="border-top: 1px solid #e5e7eb;">
              <!-- Rows injected here -->
            </div>

            <div id="analysisSummary"
              style="margin-top: 30px; padding: 20px; background: #eff6ff; border-radius: 12px; border-left: 4px solid #3b82f6;">
              <h4 style="color: #1e40af; font-size: 1rem; margin-bottom: 8px;">Overall ATS Improvement Path</h4>
              <p id="atsSummaryPath" style="font-size: 0.9rem; color: #1e3a8a; margin: 0; line-height: 1.6;"></p>
            </div>
          </div>

          <hr style="margin: 25px 0; border: 0; border-top: 1px solid #eee;">

          <p style="font-size: 0.75rem; color: var(--text-muted); font-style: italic;">
            Step 12: This ATS score is a simulated evaluation to help improve resumes. It does not guarantee selection
            or
            rejection by employers.
          </p>
        </div>
      </div>

  </div>
  <!-- =============== END RESUME VIEW =============== -->


  <!-- ================= TECHNICAL TEST VIEW REMOVED (Conflicted with dedicated setup flow) ================= -->

  <!-- =============== END TECHNICAL TEST VIEW =============== -->
  </div>
  </main>


  <script src="js/userContext.js"></script>
  <script>
    console.log("JS LOADED");
    // ===== SAFE DOM LOAD =====
    document.addEventListener("DOMContentLoaded", () => {
      const uploadBtn = document.getElementById("uploadBtn");
      const resumeFile = document.getElementById("resumeFile");

      const menuResume = document.getElementById("menuResume");
      const menuDashboard = document.getElementById("menuDashboard");

      if (!menuDashboard || !menuResume) {
        console.error("Menu buttons not found");
      }

      const UPLOAD_URL = "http://localhost:3002/api/ats/analyze-resume";
      const DASHBOARD_URL = "http://localhost:3002/dashboard/ats"; // This might need update later

      const resumeView = document.getElementById("resumeView");
      const dashboardView = document.getElementById("dashboardView");

      const circle = document.getElementById("atsProgress");
      const text = document.getElementById("atsText");
      const breakdownEl = document.getElementById("atsBreakdown");

      const radius = 70;
      const circumference = 2 * Math.PI * radius;

      circle.style.strokeDasharray = circumference;
      circle.style.strokeDashoffset = circumference;

      /* ===== COLOR LOGIC ===== */
      function colorFor(score, max) {
        const p = (score / max) * 100;
        if (p < 50) return "#ef4444";
        if (p < 75) return "#f59e0b";
        return "#16a34a";
      }

      /* ===== RENDER ATS ===== */
      function renderBreakdown(b) {
        breakdownEl.innerHTML = `
    <li>‚úì Skills Match: ${b.skills}</li>
    <li>‚úì Keywords Match: ${b.keywords}</li>
    <li>‚úì Action Verbs: ${b.actionVerbs}</li>
  `;
      }



      /* ===== UPLOAD (Refactored for Step 2-4, 9-10) ===== */
      uploadBtn.onclick = async () => {
        const file = resumeFile.files[0];
        const targetRole = document.getElementById("targetRole").value;

        if (!targetRole) {
          alert("Please select a Target Job Role first.");
          return;
        }

        if (!file) {
          alert("Please select a resume file (PDF or DOCX).");
          return;
        }

        // Show Loading (Step 10)
        document.getElementById("parsingStatus").style.display = "block";
        uploadBtn.disabled = true;
        uploadBtn.textContent = "Parsing...";

        const fd = new FormData();
        fd.append("resume", file);
        fd.append("targetRole", targetRole);
        fd.append("userId", UserContext.getUserId());

        try {
          const res = await fetch(UPLOAD_URL, { method: "POST", body: fd });
          const data = await res.json();

          document.getElementById("parsingStatus").style.display = "none";
          uploadBtn.disabled = false;
          uploadBtn.textContent = "Upload & Parse";

          if (!data.success) {
            alert(data.error || "Analysis failed");
            return;
          }

          // Show Result Card
          document.getElementById("atsResultCard").style.display = "block";
          document.getElementById("atsScoreTitle").textContent = `${data.match_score} / 100`;

          // Animate ATS (Step 10)
          animateATS(text, circle, Number(data.match_score));

          // Render Two-Column Analysis Table (Mandatory Model)
          renderAnalysisTable(data.atsFeedbackRows || []);
          document.getElementById("atsSummaryPath").textContent = data.summary;

          // Store for dashboard
          localStorage.setItem("ATS_DATA", JSON.stringify({
            total: data.match_score,
            role: targetRole
          }));

        } catch (err) {
          document.getElementById("parsingStatus").style.display = "none";
          uploadBtn.disabled = false;
          uploadBtn.textContent = "Upload & Parse";
          alert("Backend server error. Ensure server is running on port 3002.");
        }
      };

      function renderAnalysisTable(table) {
        const body = document.getElementById("analysisTableBody");

        // Anti-Empty Fallback Rule (Step 15, UI Rule)
        if (!table || table.length === 0) {
          body.innerHTML = `
            <div style="padding: 30px; text-align: center; color: var(--text-muted); font-style: italic;">
              ‚ùå Analysis data binding failed. No feedback rows detected.
            </div>`;
          return;
        }

        body.innerHTML = table.map(row => `
          <div style="display: grid; grid-template-columns: 1fr 1.2fr; gap: 15px; padding: 20px 10px; border-bottom: 1px solid #f3f4f6;">
            <div style="font-size: 0.85rem; color: #374151; line-height: 1.5;">
              <strong style="display: block; color: #4b5563; margin-bottom: 5px; font-size: 0.75rem;">${row.section.toUpperCase()} [Impact: ${row.impact}]</strong>
              ${row.error.replace(/\n/g, '<br>')}
              <div style="margin-top: 8px; color: #059669; font-weight: 600; font-size: 0.75rem;">+ ${row.potentialScoreGain} Potential Points</div>
            </div>
            <div style="font-size: 0.85rem; color: #374151; line-height: 1.5; background: #f9fafb; padding: 12px; border-radius: 8px; border-left: 3px solid #10b981;">
              ${row.correction.replace(/\n/g, '<br>')}
            </div>
          </div>
        `).join('');
      }

      function renderList(id, items) {
        const el = document.getElementById(id);
        if (!items || items.length === 0) {
          el.innerHTML = `<li style="color: var(--text-muted); font-style: italic;">No specific data points detected to provide detailed feedback for this section.</li>`;
          return;
        }
        el.innerHTML = items.map(i => `<li>${i}</li>`).join('');
      }


      // reset circle


      /* ===== BACK ===== */

      menuDashboard.onclick = async () => {
        resumeView.style.display = "none";
        dashboardView.style.display = "block";

        menuResume.classList.remove("active");
        menuDashboard.classList.add("active");

        const el = document.getElementById("dashboardATS");
        el.textContent = "0%";

        try {
          const res = await fetch(DASHBOARD_URL);
          const data = await res.json();

          if (data.ok && data.atsScore !== undefined) {
            animateCount(el, Number(data.atsScore));
          } else {
            el.textContent = "--%";
          }
        } catch (e) {
          const stored = JSON.parse(localStorage.getItem("ATS_DATA") || "{}");
          if (stored.total !== undefined) {
            animateCount(el, Number(stored.total));
          } else {
            el.textContent = "--%";
          }
        }
      };



      function animateATS(textEl, circleEl, target) {
        let current = 0;

        const interval = setInterval(() => {
          current++;
          if (current >= target) {
            current = target;
            clearInterval(interval);
          }

          textEl.textContent = current + "%";
          circleEl.style.strokeDashoffset =
            circumference - (current / 100) * circumference;

        }, 15);
      }
      function animateCount(el, target) {
        let i = 0;
        el.textContent = "0%";
        const t = setInterval(() => {
          i++;
          el.textContent = i + "%";
          if (i >= target) clearInterval(t);
        }, 15);
      }


    });

  </script>


  </script>
  <script src="technical_test.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {

      const menuButtons = document.querySelectorAll(".menu button");

      const menuResume = document.getElementById("menuResume");
      const menuTech = document.getElementById("menuTech");
      const menuComm = document.getElementById("menuComm");

      const resumeView = document.getElementById("resumeView");
      const techView = document.getElementById("technicalTestView");
      const rightContent = document.getElementById("rightContent");

      function clearActive() {
        menuButtons.forEach(b => b.classList.remove("active"));
      }

      // Resume Upload
      menuResume.onclick = () => {
        clearActive();
        menuResume.classList.add("active");

        resumeView.style.display = "block";
        techView.style.display = "none";
        rightContent.innerHTML = "";
      };

      // Technical Test - Dedicated flow via technical_test_setup.html


      // Communication Test
      menuComm.onclick = () => {
        location.href = "communication_test.html";
      };

    });
  </script>
  <script>
    document.addEventListener("click", function (e) {

      // WRITTEN CARD
      if (e.target.closest("#writtenCard")) {
        const card = e.target.closest("#writtenCard");

        // remove active from both cards
        document.querySelectorAll(".comm-card")
          .forEach(c => c.classList.remove("active"));

        card.classList.add("active");

        setTimeout(() => {
          window.location.href = "written_communication.html";
        }, 200);
      }

      // SPOKEN CARD
      if (e.target.closest("#spokenCard")) {
        const card = e.target.closest("#spokenCard");

        document.querySelectorAll(".comm-card")
          .forEach(c => c.classList.remove("active"));

        card.classList.add("active");

        setTimeout(() => {
          window.location.href = "spoken_communication.html";
        }, 200);
      }

    });
  </script>